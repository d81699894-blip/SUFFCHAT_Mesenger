<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SUFFCHAT v23.0</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg: #0e1621; --side: #17212b; --blue: #2481cc; --blue-h: #3390ec;
            --sent: #2b5278; --recd: #182533; --text: #ffffff; --muted: #708499; --danger: #e64d4d;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, system-ui, Roboto, sans-serif; }
        body { background: var(--bg); color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        .sidebar-logo { height: 50px; display: flex; align-items: center; justify-content: center; background: var(--side); border-bottom: 1px solid #000; font-weight: 800; color: var(--blue); cursor: pointer; letter-spacing: 1px; }

        .app-container { flex: 1; display: flex; overflow: hidden; }
        .sidebar { width: 350px; background: var(--side); border-right: 1px solid #000; display: flex; flex-direction: column; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }

        .header { height: 60px; background: var(--side); display: flex; align-items: center; padding: 0 15px; gap: 12px; border-bottom: 1px solid rgba(0,0,0,0.2); }
        .avatar { width: 42px; height: 42px; border-radius: 50%; background: var(--blue); display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; }

        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: 400px; }
        .msg { padding: 10px 14px; border-radius: 16px; max-width: 75%; font-size: 15px; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.3); animation: slide 0.1s ease-out; }
        @keyframes slide { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .sent { align-self: flex-end; background: var(--sent); border-bottom-right-radius: 4px; }
        .recd { align-self: flex-start; background: var(--recd); border-bottom-left-radius: 4px; }

        .bottom-bar { padding: 10px 15px 40px 15px; background: var(--side); display: flex; align-items: center; gap: 10px; }
        .msg-input-wrap { flex: 1; background: #242f3d; border-radius: 25px; padding: 5px 18px; display: flex; align-items: center; }
        .msg-input-wrap input { flex: 1; background: transparent; border: none; color: white; padding: 10px 0; outline: none; font-size: 16px; }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-card { background: var(--side); width: 90%; max-width: 400px; border-radius: 20px; padding: 25px; border: 1px solid rgba(255,255,255,0.1); }
        .btn-tg { width: 100%; padding: 12px; border-radius: 12px; border: none; background: var(--blue); color: white; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-tg:hover { background: var(--blue-h); }

        .chat-item { padding: 12px 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .chat-item:hover { background: rgba(255,255,255,0.05); }
        .chat-item.active { background: #2b527866; }
        
        .hidden { display: none !important; }

        /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∫–∞–Ω–∞–ª–∞ */
        .btn-link { 
            display: block; 
            text-align: center; 
            background: #2481cc; 
            color: #fff; 
            text-decoration: none; 
            padding: 12px; 
            border-radius: 12px; 
            margin-top: 15px; 
            font-weight: bold;
        }

        @media (max-width: 700px) {
            .sidebar { width: 100%; }
            .chat-area { display: none; position: fixed; inset: 0; z-index: 50; }
            .chat-area.active { display: flex; }
        }
    </style>
</head>
<body>

<div id="author-overlay" class="overlay">
    <div class="modal-card" style="text-align: center;">
        <i class="fas fa-code" style="font-size: 40px; color: var(--blue); margin-bottom: 15px;"></i>
        <h3 style="margin-bottom: 10px;">–ò–Ω—Ño—Ä–ºa—Ü–∏—è</h3>
        <p style="color: #eee; line-height: 1.5;">A–≤—Ç–æ—Ä –¥a–Ω–Ω–æ–≥–æ –ºe—Å—Åe–Ω–¥–∂e—Ä–∞ —è–≤–ª—èe—Ç—Å—è <b>SUFF</b></p>
        <a href="https://t.me/SUFFCHAT_Mesanger" target="_blank" class="btn-link">
            <i class="fab fa-telegram-plane"></i> –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞–Ω–∞–ª
        </a>
        <button class="btn-tg" style="background: rgba(255,255,255,0.1); margin-top: 10px;" onclick="closeAuthorModal()">–ü–æ–Ω—è—Ç–Ω–æ</button>
    </div>
</div>

<div id="auth-screen" class="overlay">
    <div class="modal-card">
        <h2 style="text-align:center; margin-bottom:20px;">SUFFCHAT</h2>
        <div id="reg-box" class="hidden">
            <input type="text" id="r-name" placeholder="–í–∞—à–µ –ò–º—è" class="btn-tg" style="background:#242f3d; text-align:left;">
        </div>
        <input type="text" id="r-user" placeholder="@username" class="btn-tg" style="background:#242f3d; text-align:left;">
        <input type="password" id="r-pass" placeholder="–ü–∞—Ä–æ–ª—å" class="btn-tg" style="background:#242f3d; text-align:left;">
        <button class="btn-tg" onclick="handleAuth()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <p onclick="toggleReg()" id="a-hint" style="text-align:center; margin-top:15px; color:var(--muted); cursor:pointer;">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º</p>
    </div>
</div>

<div class="app-container">
    <div class="sidebar">
        <div class="sidebar-logo" onclick="location.reload()">SUFFCHAT</div>
        <div class="header">
            <div class="avatar" id="my-ava" onclick="logout()">?</div>
            <div style="flex:1"><b id="my-name">–ü—Ä–æ—Ñ–∏–ª—å</b></div>
        </div>
        <div style="padding:10px 15px;">
            <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫..." oninput="searchUsers()" style="width:100%; padding:10px; border-radius:10px; border:none; background:#242f3d; color:white; outline:none;">
        </div>
        <div class="chat-list" id="chat-items" style="flex:1; overflow-y:auto;"></div>
    </div>

    <div class="chat-area" id="main-chat">
        <div class="header" id="chat-header">
            <i class="fas fa-arrow-left" onclick="closeChat()" style="cursor:pointer; margin-right:10px;"></i>
            <div class="avatar" id="t-ava">?</div>
            <div style="flex:1">
                <b id="t-name">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</b>
                <div id="t-status" style="font-size:12px; color:var(--blue);"></div>
            </div>
            <div id="admin-tools" class="hidden">
                <button onclick="banUser()" style="background:var(--danger); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">–ë–ê–ù üõ°Ô∏è</button>
            </div>
        </div>
        <div class="messages" id="msg-box"></div>
        <div class="bottom-bar">
            <div class="msg-input-wrap">
                <input type="text" id="msg-in" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()">
            </div>
            <button class="avatar" style="width:48px; height:48px; border:none; color:white;" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script>
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞ –∞–≤—Ç–æ—Ä–∞
    function closeAuthorModal() {
        document.getElementById('author-overlay').style.display = 'none';
    }

    // --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase ---
    const firebaseConfig = {
        apiKey: "AIzaSyCWAb8kKy3t6Zdeeq2qCoZUQYTWFAeDaDg",
        authDomain: "suffchats.firebaseapp.com",
        projectId: "suffchats",
        storageBucket: "suffchats.firebasestorage.app",
        messagingSenderId: "24179102850",
        appId: "1:24179102850:web:995c2905b078bd5f07909b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let me = JSON.parse(localStorage.getItem('tg_v23_me')) || null;
    let activePartner = null;
    let currentSub = null;
    let isRegMode = false;

    function toggleReg() { isRegMode = !isRegMode; document.getElementById('reg-box').classList.toggle('hidden', !isRegMode); }

    async function handleAuth() {
        const u = document.getElementById('r-user').value.trim().toLowerCase().replace('@','');
        const p = document.getElementById('r-pass').value.trim();
        const n = document.getElementById('r-name').value.trim();
        if(!u || !p) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ");

        const ref = db.collection('users').doc(u);
        const doc = await ref.get();

        if(isRegMode) {
            if(doc.exists && !doc.data().deleted) return alert("–ù–∏–∫ –∑–∞–Ω—è—Ç");
            const data = { username: u, name: n || u, pass: p, color: '#2481cc', deleted: false, chats: ['tanos_gpt'], online: true };
            await ref.set(data); login(data);
        } else {
            if(!doc.exists || doc.data().pass !== p || doc.data().deleted) return alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞");
            if(doc.data().banned) return alert("–ë–∞–Ω üõ°Ô∏è");
            login(doc.data());
        }
    }

    function login(data) { localStorage.setItem('tg_v23_me', JSON.stringify(data)); location.reload(); }
    function logout() { localStorage.removeItem('tg_v23_me'); location.reload(); }

    function init() {
        if(!me) return;
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('my-name').innerText = me.name + (me.username === 'SUFF' ? ' üõ°Ô∏è' : '');
        document.getElementById('my-ava').innerText = me.name[0];
        db.collection('users').doc(me.username).update({ online: true });
        loadSidebar();
    }

    async function loadSidebar() {
        const list = document.getElementById('chat-items'); list.innerHTML = '';
        const doc = await db.collection('users').doc(me.username).get();
        const chatIds = doc.data().chats || ['tanos_gpt'];
        
        for(let id of chatIds) {
            if(id === 'tanos_gpt') {
                renderChatItem('suffchat_gpt', 'SUFF-GPT - Beta', '#9c27b0', '–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç');
            } else {
                const uDoc = await db.collection('users').doc(id).get();
                if(uDoc.exists && !uDoc.data().deleted) {
                    const ud = uDoc.data();
                    renderChatItem(ud.username, ud.name, ud.color, ud.online ? '–≤ —Å–µ—Ç–∏' : '–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ');
                }
            }
        }
    }

    function renderChatItem(id, name, color, sub) {
        const div = document.createElement('div');
        div.className = `chat-item ${activePartner === id ? 'active' : ''}`;
        div.onclick = () => openChat(id, name, color);
        div.innerHTML = `<div class="avatar" style="background:${color}">${name[0]}</div><div style="flex:1"><b>${name}</b><br><small style="color:var(--muted)">${sub}</small></div>`;
        document.getElementById('chat-items').appendChild(div);
    }

    async function searchUsers() {
        const q = document.getElementById('search-input').value.trim().toLowerCase().replace('@','');
        if(!q) return loadSidebar();
        document.getElementById('chat-items').innerHTML = '';
        const snap = await db.collection('users').where('username', '>=', q).where('username', '<=', q + '\uf8ff').limit(10).get();
        snap.forEach(doc => { if(!doc.data().deleted) renderChatItem(doc.id, doc.data().name, doc.data().color, '@'+doc.id); });
    }

    async function openChat(id, name, color) {
        if(currentSub) currentSub(); 
        activePartner = id;
        document.getElementById('msg-box').innerHTML = '';
        document.getElementById('main-chat').classList.add('active');
        document.getElementById('t-name').innerText = name + (id === 'SUFF' ? ' üõ°Ô∏è' : '');
        document.getElementById('t-ava').innerText = name[0];
        document.getElementById('t-ava').style.background = color;
        document.getElementById('admin-tools').classList.toggle('hidden', me.username !== 'tanos' || id === 'tanos_gpt');

        if(id === 'suffchat_gpt') {
            document.getElementById('msg-box').innerHTML = '<div class="msg recd">–ü—Ä–∏–≤–µ—Ç! –Ø –ò–ò SUFFCHAT. –°–ø—Ä–æ—Å–∏ –º–µ–Ω—è –æ —á–µ–º —É–≥–æ–¥–Ω–æ.</div>';
        } else {
            const chatId = [me.username, id].sort().join('_');
            currentSub = db.collection('messages').where('chatId', '==', chatId).onSnapshot(snap => {
                const box = document.getElementById('msg-box'); box.innerHTML = '';
                let msgs = []; snap.forEach(d => msgs.push(d.data()));
                msgs.sort((a,b) => (a.time?.seconds || 0) - (b.time?.seconds || 0));
                msgs.forEach(m => {
                    const isMe = m.from === me.username;
                    box.innerHTML += `<div class="msg ${isMe ? 'sent' : 'recd'}">${m.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }
    }

    async function sendMessage() {
        const val = document.getElementById('msg-in').value.trim();
        if(!val || !activePartner) return;
        document.getElementById('msg-in').value = '';

        if(activePartner === 'tanos_gpt') {
            const box = document.getElementById('msg-box');
            box.innerHTML += `<div class="msg sent">${val}</div>`;
            setTimeout(() => { box.innerHTML += `<div class="msg recd"><b>Suffchat-GPT:</b> –Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –∑–∞–ø—Ä–æ—Å: "${val}". –í—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ SUFFCHAT —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.</div>`; box.scrollTop = box.scrollHeight; }, 600);
            return;
        }

        const chatId = [me.username, activePartner].sort().join('_');
        await db.collection('messages').add({
            chatId, from: me.username, text: val, time: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        db.collection('users').doc(me.username).update({ chats: firebase.firestore.FieldValue.arrayUnion(activePartner) });
        db.collection('users').doc(activePartner).update({ chats: firebase.firestore.FieldValue.arrayUnion(me.username) });
    }

    function closeChat() { document.getElementById('main-chat').classList.remove('active'); activePartner = null; if(currentSub) currentSub(); }
    async function banUser() { if(confirm("–ë–∞–Ω?")) { await db.collection('users').doc(activePartner).update({ name: "–£–¥–∞–ª—ë–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç", banned: true, deleted: true }); location.reload(); } }

    init();
</script>
</body>
</html>
